<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ZapYield | Debugged v1.1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/components.css" rel="stylesheet" type="text/css">
  <link href="css/shade-be5342c59f721d0abcf-07a16bef20d09.css" rel="stylesheet" type="text/css">
</head>
<body class="body-2">
  <div class="zy-header">
    <div class="zy-inner">
      <a href="#" class="zy-logo w-inline-block">
        <div class="text-block-31">ZapYields</div>
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 25" fill="none">
          <path d="M8.50001 23.968C8.20001 23.968 7.90001 23.868 7.60001 23.768C6.80001 23.368 6.40001 22.568 6.60001 21.768L7.80001 15.968H6.00001C5.20001 15.968 4.50001 15.468 4.20001 14.768C3.90001 14.068 4.00001 13.268 4.60001 12.768L14.1 2.66801C14.7 2.06801 15.7 1.86801 16.4 2.26801C17.2 2.66801 17.6 3.46801 17.4 4.26801L16.2 10.068H18C18.8 10.068 19.5 10.568 19.8 11.268C20.1 11.968 20 12.768 19.4 13.268L9.90001 23.368C9.50001 23.768 9.00001 23.968 8.50001 23.968Z" fill="#facc15"></path>
        </svg>
      </a>
      <a href="#" id="connectBtn" class="zy-connect-wallet w-button">Connect Wallet</a>
    </div>
  </div>

  <div class="zy-main-container">
    <div class="zy-main-app">
      <div class="zmp-inner">
        <h1 class="zy-h1">Vault Dashboard</h1>
        <div class="zy-2-cols">
          <div class="zy-col1">
            <h2 class="heading-9">Investment</h2>
            <div class="div-block-89">
              <input placeholder="Min 10" type="number" id="amountInput" class="input-field" style="color: black !important;">
              <div class="zy-btns">
                <a href="#" id="approveBtn" class="button-3 w-button">1. Approve</a>
                <a href="#" id="zapInBtn" class="zy-approve w-button">2. Zap In</a>
              </div>
              <p id="statusLabel" style="font-size: 11px; margin-top: 15px; color: #facc15; text-align: center; font-weight: bold;">System Initialized</p>
            </div>
          </div>
          <div class="zy-col1">
            <h2 class="heading-9">Live Stats</h2>
            <div class="ls-yb">
              <div class="zy-yb-text">Yield Balance: $<span id="yieldBalance">0.00</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const VAULT_ADDR = "0x2392e90da0f0De5FD1Fa0978a244CcEE23b6CeF2";
    const USDC_ADDR = "0x036CbD53842c5426634e7929541eC2318f3dCF7e";
    const V_ABI = [
        "function zapIn(uint256 a, address r) external", 
        "function getAccountValue(address u) view returns (uint256)"
    ];
    const U_ABI = [
        "function approve(address s, uint256 a) public returns (bool)",
        "function balanceOf(address a) view returns (uint256)"
    ];

    let signer, vault, usdc;

    window.onload = () => {
      document.getElementById('connectBtn').onclick = connect;
      document.getElementById('approveBtn').onclick = approve;
      document.getElementById('zapInBtn').onclick = zapIn;
    };

    async function connect() {
      if (!window.ethereum) return alert("MetaMask not found!");
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      vault = new ethers.Contract(VAULT_ADDR, V_ABI, signer);
      usdc = new ethers.Contract(USDC_ADDR, U_ABI, signer);
      
      const addr = await signer.getAddress();
      document.getElementById('connectBtn').innerText = addr.substring(0,6) + "...";
      updateStatus("Connected!");
      refresh(addr);
    }

    async function approve() {
      const val = document.getElementById('amountInput').value;
      if (val < 10) return updateStatus("Error: Minimum 10 USDC Required");
      
      try {
        updateStatus("Checking Balance...");
        const addr = await signer.getAddress();
        const bal = await usdc.balanceOf(addr);
        if (bal.lt(ethers.utils.parseUnits(val, 6))) {
            return updateStatus("Error: Insufficient USDC Balance!");
        }

        updateStatus("Requesting Approval...");
        const tx = await usdc.approve(VAULT_ADDR, ethers.utils.parseUnits(val, 6));
        await tx.wait();
        updateStatus("Approved! Ready to Zap In.");
      } catch (e) { 
          console.error(e);
          updateStatus("Approval Failed: RPC Error"); 
      }
    }

    async function zapIn() {
      const val = document.getElementById('amountInput').value;
      try {
        updateStatus("Zapping...");
        const ref = new URLSearchParams(window.location.search).get('ref') || "0x0000000000000000000000000000000000000000";
        
        // This is where -32603 usually triggers
        const tx = await vault.zapIn(ethers.utils.parseUnits(val, 6), ref);
        await tx.wait();
        updateStatus("Zap Success!");
        refresh(await signer.getAddress());
      } catch (e) { 
          console.error(e);
          // Catching the RPC error to provide a hint
          updateStatus("Error: Contract Reverted. (Check Min $10 or Approval)"); 
      }
    }

    async function refresh(addr) {
      const bal = await vault.getAccountValue(addr);
      document.getElementById('yieldBalance').innerText = ethers.utils.formatUnits(bal, 6);
    }

    function updateStatus(msg) { document.getElementById('statusLabel').innerText = msg; }
  </script>
</body>
</html>