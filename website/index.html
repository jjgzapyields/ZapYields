<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ZapYield | Persistent Session</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/components.css" rel="stylesheet" type="text/css">
  <link href="css/shade-be5342c59f721d0abcf-07a16bef20d09.css" rel="stylesheet" type="text/css">
</head>
<body class="body-2">
  <div class="zy-header">
    <div class="zy-inner">
      <a href="#" class="zy-logo w-inline-block">
        <div class="text-block-31">ZapYields</div>
      </a>
      <a href="#" id="connectBtn" class="zy-connect-wallet w-button">Connect Wallet</a>
    </div>
  </div>

  <div class="zy-main-container">
    <div class="zy-main-app">
      <div class="zmp-inner">
        <h1 class="zy-h1" id="welcomeText">Welcome to ZapYields</h1>
        <div class="zy-2-cols">
          <div class="zy-col1">
            <h2 class="heading-9">Investment</h2>
            <div class="div-block-89">
              <input placeholder="Min 10" type="number" id="amountInput" class="input-field" style="color: black !important;">
              <div class="zy-btns">
                <a href="#" id="approveBtn" class="button-3 w-button">1. Approve</a>
                <a href="#" id="zapInBtn" class="zy-approve w-button">2. Zap In</a>
              </div>
              <p id="statusLabel" style="font-size: 11px; margin-top: 15px; color: #facc15; text-align: center;">Initializing...</p>
            </div>
          </div>
          <div class="zy-col1">
            <h2 class="heading-9">Live Stats</h2>
            <div class="ls-yb">
              <div class="zy-yb-text">Yield Balance: $<span id="yieldBalance">0.00</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const VAULT_ADDR = "0x2392e90da0f0De5FD1Fa0978a244CcEE23b6CeF2";
    const V_ABI = ["function getAccountValue(address u) view returns (uint256)"];

    let signer, provider, vault;

    // --- AUTOMATIC LOAD LOGIC ---
    window.onload = async () => {
      document.getElementById('connectBtn').onclick = connect;
      
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // 1. Check if we already have permission (Silent Check)
        const accounts = await provider.listAccounts();
        if (accounts.length > 0) {
          console.log("Found existing session for:", accounts[0]);
          setupWallet(accounts[0]);
        } else {
          updateStatus("Wallet Disconnected");
        }

        // 2. Listen for Account Changes (Auto-switch)
        window.ethereum.on('accountsChanged', (newAccounts) => {
          if (newAccounts.length > 0) setupWallet(newAccounts[0]);
          else window.location.reload();
        });
      }
    };

    async function connect() {
      if (!window.ethereum) return alert("MetaMask not found!");
      updateStatus("Requesting Connection...");
      const accounts = await provider.send("eth_requestAccounts", []);
      setupWallet(accounts[0]);
    }

    async function setupWallet(addr) {
      signer = provider.getSigner();
      vault = new ethers.Contract(VAULT_ADDR, V_ABI, signer);
      
      document.getElementById('connectBtn').innerText = addr.substring(0,6) + "...";
      document.getElementById('welcomeText').innerText = "Welcome Back!";
      updateStatus("Session Restored");
      refresh(addr);
    }

    async function refresh(addr) {
      try {
        const bal = await vault.getAccountValue(addr);
        document.getElementById('yieldBalance').innerText = ethers.utils.formatUnits(bal, 6);
      } catch (e) { console.error("Refresh error", e); }
    }

    function updateStatus(msg) { document.getElementById('statusLabel').innerText = msg; }
  </script>
</body>
</html>