<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ZapYield | Debug Mode</title>
  
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
  
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/components.css" rel="stylesheet" type="text/css">
  <link href="css/shade-be5342c59f721d0abcf-07a16bef20d09.css" rel="stylesheet" type="text/css">
</head>
<body class="body-2">
  <div class="zy-header">
    <div class="zy-inner">
      <a href="#" class="zy-logo w-inline-block">
        <div class="text-block-31">ZapYields</div>
      </a>
      <a href="#" id="connectBtn" class="zy-connect-wallet w-button">Connect Wallet</a>
    </div>
  </div>
  
  <p id="statusLabel" style="color: #facc15; text-align: center;">Checking Library...</p>

  <script>
    // 2. IMMEDIATE CHECK
    console.log("Checking for ethers library...");
    if (typeof ethers !== 'undefined') {
        console.log("Ethers.js v" + ethers.version + " loaded successfully.");
        document.getElementById('statusLabel').innerText = "Library Ready - Connect Wallet";
    } else {
        console.error("Library failed to load from CDN.");
        document.getElementById('statusLabel').innerText = "ERROR: Library not loaded. Check internet.";
    }

    const VAULT_ADDRESS = "0x2392e90da0f0De5FD1Fa0978a244CcEE23b6CeF2";
    const USDC_ADDRESS = "0x036CbD53842c5426634e7929541eC2318f3dCF7e";
    const VAULT_ABI = [
      "function zapIn(uint256 _amount, address _referrer) external",
      "function getAccountValue(address _user) external view returns (uint256)",
      "function getDownlines(address _user) external view returns (address[] memory)"
    ];

    let signer, vaultContract;

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('connectBtn').onclick = connectWallet;
    });

    async function connectWallet(e) {
      if(e) e.preventDefault();
      
      // Safety check before running connection logic
      if (typeof ethers === 'undefined') {
          return alert("Ethers library is not loaded. Try refreshing the page.");
      }

      if (window.ethereum) {
        try {
          // Use window.ethers to be explicit
          const provider = new window.ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          
          vaultContract = new window.ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);
          
          const addr = await signer.getAddress();
          document.getElementById('connectBtn').innerText = addr.substring(0,6) + "...";
          document.getElementById('statusLabel').innerText = "Connected!";
        } catch (err) { 
          console.error(err);
          document.getElementById('statusLabel').innerText = "Connection Failed";
        }
      } else {
        alert("MetaMask not found. Please use a local server like Live Server.");
      }
    }
  </script>
</body>
</html>