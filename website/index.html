<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ZapYield | Mainnet Live</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/shade-be5342c59f721d0abcf-07a16bef20d09.css" rel="stylesheet" type="text/css">
</head>
<body class="body-2">
  <div class="zy-header">
    <div class="zy-inner">
      <div class="zy-logo">ZapYieldsâš¡ <span style="font-size: 10px; color: #facc15;">MAINNET</span></div>
      <div class="header-btns">
        <a href="#" id="connectBtn" class="zy-connect-wallet w-button">Connect Wallet</a>
        <a href="#" id="disconnectBtn" class="w-button" style="display:none; background:#450a0a;">Disconnect</a>
      </div>
    </div>
  </div>

  <div class="zy-main-container">
    <div class="zmp-inner">
      <div class="zy-col1">
        <input type="number" id="amountInput" placeholder="Min 10 USDC" class="input-field" style="color:black;">
        <button id="approveBtn" class="button-3 w-button">1. Approve</button>
        <button id="zapInBtn" class="zy-approve w-button">2. Zap In</button>
        <p id="statusLabel" style="color:#facc15; text-align:center; margin-top:10px;">Connect to Base Mainnet</p>
      </div>
      <div class="ls-yb">
        <div>Live Vault Value: <strong id="yieldDisplay">$0.00</strong></div>
      </div>
    </div>
  </div>

  <script>
    const MAINNET_CHAIN_ID = 8453;
    const MAINNET_CHAIN_HEX = "0x2105";
    const VAULT_ADDR = "0x15f51f8106E9d647922495B6e1B1171fEFA8F50d";
    const USDC_ADDR = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";

    const V_ABI = ["function zapIn(uint256 a, address r) external", "function getAccountValue(address u) view returns (uint256)"];
    const U_ABI = ["function approve(address s, uint256 a) public returns (bool)"];

    let signer, provider, vault, usdc;

    window.onload = async () => {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        window.ethereum.on('chainChanged', () => window.location.reload());
        
        const accounts = await provider.listAccounts();
        if (accounts.length > 0) setup(accounts[0]);
      }
      document.getElementById('connectBtn').onclick = connect;
    };

    async function connect() {
      try {
        // Request Network Switch to Mainnet
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: MAINNET_CHAIN_HEX }],
        });
        const accounts = await provider.send("eth_requestAccounts", []);
        setup(accounts[0]);
      } catch (err) {
        if (err.code === 4902) alert("Please add Base Mainnet to MetaMask");
        console.error(err);
      }
    }

    async function setup(addr) {
      const { chainId } = await provider.getNetwork();
      if (chainId !== MAINNET_CHAIN_ID) return updateStatus("Wrong Network - Switch to Base", true);

      signer = provider.getSigner();
      vault = new ethers.Contract(VAULT_ADDR, V_ABI, signer);
      usdc = new ethers.Contract(USDC_ADDR, U_ABI, signer);

      document.getElementById('connectBtn').innerText = addr.substring(0,6) + "...";
      updateStatus("Connected to Mainnet");
      refresh(addr);
    }

    async function refresh(addr) {
      try {
        const bal = await vault.getAccountValue(addr);
        document.getElementById('yieldDisplay').innerText = "$" + ethers.utils.formatUnits(bal, 6);
      } catch (err) { console.error(err); }
    }

    async function handleApprove() {
        const val = document.getElementById('amountInput').value;
        const tx = await usdc.approve(VAULT_ADDR, ethers.utils.parseUnits(val, 6));
        await tx.wait();
        updateStatus("Approved!");
    }

    function updateStatus(msg) { document.getElementById('statusLabel').innerText = msg; }
  </script>
</body>
</html>